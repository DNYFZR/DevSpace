################################
######## Build Pipeline ########
################################

name: 'Build_Pipeline'

# On pull request or push to main branch src & dependecies
on:
  workflow_run:
    workflows: ['CI_Pipeline']
    types:
      - completed
    branches:
      - main
    paths:
      - src/**
      - dependencies/**
  
  create:
    tags:
      - dev*

# Permissions for private repo
permissions:
  contents: write
  issues: read
  checks: write
  pull-requests: write

jobs:
  BuildLibrary:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
# Set-up Linux VM 
    runs-on: 'ubuntu-latest'

# Check out repo
    steps:
    - name: Checkout repo content
      uses: actions/checkout@v2 

# Install Python & upgrade pip
    - name: Install python
      uses: actions/setup-python@v2
      with:
        python-version: '3.9.10' 

    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip

# Install dependencies
    - name: Install dependencies
      run: |
        pip install build
        pip install --upgrade setuptools 
        pip install -r dependencies/requirements.txt

# Build package
    - name: Build distribution
      run: |
        cd src/
        python -m build --sdist --wheel --outdir dist/

# Publish artifacts
    - name: Publish GitHub Release Artifacts
      if: ${{ startsWith(github.ref, 'refs/tags/') }}
      uses: SierraSoftworks/gh-releases@v1.0.6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        overwrite: 'true'
        files: |
          **.whl